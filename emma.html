<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emma AI Assistant</title>
    <style>
        /* Previous styles remain the same */
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
        }

        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: #000;
            transition: opacity 0.3s ease;
        }

        .background-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            max-width: 100vw;
            max-height: 100vh;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        elevenlabs-convai {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1;
            padding-bottom: env(safe-area-inset-bottom);
        }

        #debugPanel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 5px;
            border: 1px solid #00ff00;
        }
    </style>
</head>
<body>
    <div id="debugPanel"></div>

    <div class="background-container" id="defaultBg">
        <img class="background-image" src="emma.png" alt="Emma Background">
    </div>

    <div class="background-container hidden" id="speakingBg">
        <img class="background-image" src="emma2.png" alt="Emma Speaking Background">
    </div>

    <elevenlabs-convai 
        id="convai-widget" 
        agent-id="UFCiWykxf7I8pgANcBuJ">
    </elevenlabs-convai>
    
    <script src="https://elevenlabs.io/convai-widget/index.js" async type="text/javascript"></script>

    <script>
        const debugPanel = document.getElementById('debugPanel');
        const defaultBg = document.getElementById('defaultBg');
        const speakingBg = document.getElementById('speakingBg');
        
        // State tracking
        let currentlyPlaying = false;
        let lastStateChange = Date.now();
        const DEBOUNCE_TIME = 300; // ms to wait before allowing another state change

        function log(type, message, data = null) {
            const time = new Date().toLocaleTimeString();
            console.log(`[${time}] [${type}]`, message, data || '');
            
            const entry = document.createElement('div');
            entry.style.borderBottom = '1px solid #333';
            entry.style.marginBottom = '5px';
            entry.style.paddingBottom = '5px';
            entry.innerHTML = `
                <span style="color: #888">[${time}]</span>
                <span style="color: #ff9900">[${type}]</span>
                <span>${message}</span>
                ${data ? `<br><span style="color: #888">${JSON.stringify(data)}</span>` : ''}
            `;
            
            debugPanel.insertBefore(entry, debugPanel.firstChild);
            if (debugPanel.children.length > 50) debugPanel.removeChild(debugPanel.lastChild);
        }

        function switchBackground(speaking) {
            // Prevent rapid switching
            const now = Date.now();
            if (now - lastStateChange < DEBOUNCE_TIME) return;
            
            // Only switch if state actually changed
            if (speaking !== currentlyPlaying) {
                log('BACKGROUND', `Switching to ${speaking ? 'speaking' : 'default'} background`);
                currentlyPlaying = speaking;
                lastStateChange = now;

                if (speaking) {
                    defaultBg.classList.add('hidden');
                    speakingBg.classList.remove('hidden');
                } else {
                    defaultBg.classList.remove('hidden');
                    speakingBg.classList.add('hidden');
                }
            }
        }

        function setupAudioListeners(audioElement) {
            log('AUDIO', 'Setting up listeners for audio element');

            audioElement.addEventListener('play', () => {
                log('AUDIO', 'Play event detected');
                switchBackground(true);
            });

            audioElement.addEventListener('pause', () => {
                log('AUDIO', 'Pause event detected');
                switchBackground(false);
            });

            audioElement.addEventListener('ended', () => {
                log('AUDIO', 'End event detected');
                switchBackground(false);
            });
        }

        function observeWidget() {
            const widget = document.getElementById('convai-widget');
            if (!widget) return;

            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.addedNodes.length) {
                        mutation.addedNodes.forEach((node) => {
                            if (node.tagName === 'AUDIO') {
                                setupAudioListeners(node);
                            }
                            // Check for audio elements in subtree
                            if (node.querySelectorAll) {
                                node.querySelectorAll('audio').forEach(setupAudioListeners);
                            }
                        });
                    }
                });
            });

            observer.observe(widget, {
                childList: true,
                subtree: true
            });

            // Gentle periodic check
            setInterval(() => {
                if (!document.getElementsByTagName('audio').length) return;
                
                const anyPlaying = Array.from(document.getElementsByTagName('audio'))
                    .some(audio => !audio.paused && audio.currentTime > 0);
                
                if (anyPlaying !== currentlyPlaying) {
                    switchBackground(anyPlaying);
                }
            }, 1000); // Check every second instead of every 100ms
        }

        // Initialize when the page loads
        window.addEventListener('load', () => {
            log('INIT', 'Page loaded');
            setTimeout(observeWidget, 1000);
        });
    </script>
</body>
</html>
