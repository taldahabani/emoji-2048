<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emma AI Assistant</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
        }

        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: #000;
            transition: opacity 0.3s ease;
        }

        .background-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            max-width: 100vw;
            max-height: 100vh;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        elevenlabs-convai {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1;
            padding-bottom: env(safe-area-inset-bottom);
        }

        #debugPanel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 5px;
            border: 1px solid #00ff00;
        }
    </style>
</head>
<body>
    <div id="debugPanel"></div>

    <div class="background-container" id="defaultBg">
        <img class="background-image" src="emma.png" alt="Emma Background">
    </div>

    <div class="background-container hidden" id="speakingBg">
        <img class="background-image" src="emma2.png" alt="Emma Speaking Background">
    </div>

    <elevenlabs-convai id="convai-widget" agent-id="UFCiWykxf7I8pgANcBuJ"></elevenlabs-convai>
    
    <script src="https://elevenlabs.io/convai-widget/index.js" async type="text/javascript"></script>

    <script>
        const debugPanel = document.getElementById('debugPanel');
        const defaultBg = document.getElementById('defaultBg');
        const speakingBg = document.getElementById('speakingBg');

        function log(type, message, data = null) {
            const time = new Date().toLocaleTimeString();
            console.log(`[${time}] [${type}]`, message, data || '');
            
            const entry = document.createElement('div');
            entry.style.borderBottom = '1px solid #333';
            entry.style.marginBottom = '5px';
            entry.style.paddingBottom = '5px';
            entry.innerHTML = `
                <span style="color: #888">[${time}]</span>
                <span style="color: #ff9900">[${type}]</span>
                <span>${message}</span>
                ${data ? `<br><span style="color: #888">${JSON.stringify(data)}</span>` : ''}
            `;
            
            debugPanel.insertBefore(entry, debugPanel.firstChild);
            if (debugPanel.children.length > 50) debugPanel.removeChild(debugPanel.lastChild);
        }

        function switchBackground(speaking) {
            log('BACKGROUND', `Switching to ${speaking ? 'speaking' : 'default'} background`);
            if (speaking) {
                defaultBg.classList.add('hidden');
                speakingBg.classList.remove('hidden');
            } else {
                defaultBg.classList.remove('hidden');
                speakingBg.classList.add('hidden');
            }
        }

        // Monitor for audio elements
        function setupAudioMonitoring() {
            const widget = document.getElementById('convai-widget');
            if (!widget) return;

            // Function to check if any audio is playing in the widget
            function checkAudioState() {
                const audioElements = widget.getElementsByTagName('audio');
                let isPlaying = false;

                for (let audio of audioElements) {
                    if (!audio.paused && !audio.ended && audio.currentTime > 0) {
                        isPlaying = true;
                        break;
                    }
                }

                switchBackground(isPlaying);
            }

            // Create MutationObserver to watch for new audio elements
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.addedNodes.length) {
                        mutation.addedNodes.forEach((node) => {
                            if (node.nodeName === 'AUDIO') {
                                log('AUDIO', 'New audio element detected');
                                
                                // Monitor this audio element
                                node.addEventListener('play', () => {
                                    log('AUDIO', 'Audio started playing');
                                    switchBackground(true);
                                });

                                node.addEventListener('pause', () => {
                                    log('AUDIO', 'Audio paused');
                                    switchBackground(false);
                                });

                                node.addEventListener('ended', () => {
                                    log('AUDIO', 'Audio ended');
                                    switchBackground(false);
                                });
                            }
                        });
                    }
                });
            });

            // Start observing the widget
            observer.observe(widget, {
                childList: true,
                subtree: true
            });

            // Also check periodically for audio state
            setInterval(checkAudioState, 100);

            log('INIT', 'Audio monitoring system initialized');
        }

        // Initialize everything when the page loads
        window.addEventListener('load', () => {
            log('INIT', 'Page loaded');
            
            // Wait a bit for the widget to initialize
            setTimeout(() => {
                setupAudioMonitoring();
                log('INIT', 'Setup complete');
            }, 1000);
        });

        // Backup check for widget initialization
        const checkWidget = setInterval(() => {
            const widget = document.getElementById('convai-widget');
            if (widget && widget.shadowRoot) {
                clearInterval(checkWidget);
                log('INIT', 'Widget shadow root detected');
                setupAudioMonitoring();
            }
        }, 500);
    </script>
</body>
</html>
