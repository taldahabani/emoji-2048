<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emma AI Assistant</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
        }

        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: #000;
            transition: opacity 0.3s ease;
        }

        .background-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            max-width: 100vw;
            max-height: 100vh;
        }

        .hidden {
            opacity: 0;
            pointer-events: none;
        }

        elevenlabs-convai {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1;
            padding-bottom: env(safe-area-inset-bottom);
        }

        #debugPanel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 5px;
            border: 1px solid #00ff00;
        }

        @media screen and (max-width: 768px) {
            .background-image {
                object-position: center center;
            }
        }
    </style>
</head>
<body>
    <div id="debugPanel"></div>

    <div class="background-container" id="defaultBg">
        <img class="background-image" src="emma.png" alt="Emma Background">
    </div>

    <div class="background-container hidden" id="speakingBg">
        <img class="background-image" src="emma2.png" alt="Emma Speaking Background">
    </div>

    <!-- Updated widget with ALL possible events -->
    <elevenlabs-convai 
        id="convai-widget" 
        agent-id="UFCiWykxf7I8pgANcBuJ"
        client-events='["switchBackground", "audio", "interruption", "connection", "message", "error"]'
        onAudioPlay="handleAudioPlay()"
        onAudioEnd="handleAudioEnd()"
        onError="handleError(event)"
        onConnectionUpdate="handleConnection(event)"
        onMessage="handleMessage(event)">
    </elevenlabs-convai>
    
    <script src="https://elevenlabs.io/convai-widget/index.js" async type="text/javascript"></script>

    <script>
        const debugPanel = document.getElementById('debugPanel');
        const defaultBg = document.getElementById('defaultBg');
        const speakingBg = document.getElementById('speakingBg');

        function log(type, message, data = null) {
            const time = new Date().toLocaleTimeString();
            console.log(`[${time}] [${type}]`, message, data || '');
            
            const entry = document.createElement('div');
            entry.style.borderBottom = '1px solid #333';
            entry.style.marginBottom = '5px';
            entry.style.paddingBottom = '5px';
            entry.innerHTML = `
                <span style="color: #888">[${time}]</span>
                <span style="color: #ff9900">[${type}]</span>
                <span>${message}</span>
                ${data ? `<br><span style="color: #888">${JSON.stringify(data)}</span>` : ''}
            `;
            
            debugPanel.insertBefore(entry, debugPanel.firstChild);
            if (debugPanel.children.length > 50) debugPanel.removeChild(debugPanel.lastChild);
        }

        // Event Handlers
        function handleAudioPlay() {
            log('AUDIO', '▶️ Audio Started Playing');
            switchBackground(true);
        }

        function handleAudioEnd() {
            log('AUDIO', '⏹️ Audio Ended');
            switchBackground(false);
        }

        function handleError(event) {
            log('ERROR', '❌ Error occurred', event.detail);
        }

        function handleConnection(event) {
            log('CONNECTION', '🔌 Connection update', event.detail);
        }

        function handleMessage(event) {
            log('MESSAGE', '💬 Message received', event.detail);
        }

        function switchBackground(speaking) {
            log('BACKGROUND', `🔄 Switching background - Speaking: ${speaking}`);
            if (speaking) {
                defaultBg.classList.add('hidden');
                speakingBg.classList.remove('hidden');
            } else {
                defaultBg.classList.remove('hidden');
                speakingBg.classList.add('hidden');
            }
        }

        // Listen for all possible events
        document.addEventListener('DOMContentLoaded', () => {
            log('INIT', '🚀 Page loaded, setting up event listeners');
            
            const widget = document.getElementById('convai-widget');
            
            // Listen for custom events
            window.addEventListener('message', (event) => {
                if (event.data && event.data.type === 'elevenlabs-convai') {
                    log('EVENT', '📨 Widget event received', event.data);
                    
                    switch(event.data.event) {
                        case 'switchBackground':
                            switchBackground(event.data.detail.speaking);
                            break;
                        case 'audio-playing':
                            handleAudioPlay();
                            break;
                        case 'audio-stopped':
                        case 'audio-end':
                            handleAudioEnd();
                            break;
                    }
                }
            });

            // Add direct event listeners
            if (widget) {
                widget.addEventListener('audioPlay', handleAudioPlay);
                widget.addEventListener('audioEnd', handleAudioEnd);
                widget.addEventListener('error', handleError);
                widget.addEventListener('connectionUpdate', handleConnection);
                widget.addEventListener('message', handleMessage);
                
                log('INIT', '✅ Widget event listeners attached');
            }
        });
    </script>
</body>
</html>
