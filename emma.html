<!DOCTYPE html>
<html lang="en">
<!-- ... (keep all the previous head and style content the same) ... -->
<body>
    <div id="debugPanel"></div>
    <div id="debugControls">
        <button class="debug-button" onclick="clearDebug()">Clear Debug</button>
        <button class="debug-button" onclick="toggleDebug()">Toggle Debug</button>
    </div>

    <div class="background-container" id="defaultBg">
        <img class="background-image" src="emma.png" alt="Emma Background">
    </div>

    <div class="background-container hidden" id="speakingBg">
        <img class="background-image" src="emma2.png" alt="Emma Speaking Background">
    </div>

    <!-- Updated widget with explicit event handlers -->
    <elevenlabs-convai 
        id="convai-widget" 
        agent-id="UFCiWykxf7I8pgANcBuJ"
        client-events='["switchBackground", "audio", "interruption", "connection", "message", "error"]'
        onmessage="handleWidgetMessage(event)"
        onaudiostart="handleAudioStart()"
        onaudioend="handleAudioEnd()"
        oninterruption="handleInterruption()"
        onconnectionupdate="handleConnection(event)"
        onerror="handleError(event)">
    </elevenlabs-convai>
    
    <script src="https://elevenlabs.io/convai-widget/index.js" async type="text/javascript"></script>

    <script>
        // ... (keep existing debug panel and logging functions) ...

        // New Event Handlers
        function handleWidgetMessage(event) {
            log('WIDGET', 'Message received', event.detail);
        }

        function handleAudioStart() {
            log('AUDIO', '🎤 Audio started');
            switchBackground(true);
        }

        function handleAudioEnd() {
            log('AUDIO', '🔇 Audio ended');
            switchBackground(false);
        }

        function handleInterruption() {
            log('AUDIO', '⚠️ Audio interrupted');
            switchBackground(false);
        }

        function handleConnection(event) {
            log('CONNECTION', '🔌 Connection update', event.detail);
        }

        function handleError(event) {
            log('ERROR', '❌ Error occurred', event.detail);
        }

        // Message Event Handler
        window.addEventListener('message', (event) => {
            if (event.data.type === 'elevenlabs-convai') {
                log('CLIENT', 'Received client event', event.data);
                switch (event.data.event) {
                    case 'switchBackground':
                        const speaking = event.data.detail?.speaking;
                        log('CLIENT', 'Received switchBackground command', {
                            speaking: speaking,
                            detail: event.data.detail
                        });
                        switchBackground(speaking);
                        break;
                    case 'audio':
                        const audioEvent = event.data.detail;
                        log('CLIENT', 'Received audio event', audioEvent);
                        if (audioEvent.status === 'playing') {
                            handleAudioStart();
                        } else if (audioEvent.status === 'ended') {
                            handleAudioEnd();
                        }
                        if (audioEvent.interruption) {
                            handleInterruption();
                        }
                        break;
                    default:
                        log('CLIENT', 'Unhandled event type', event.data.event);
                }
            }
        });

        // Direct Event Listeners for Widget
        document.addEventListener('DOMContentLoaded', () => {
            const widget = document.getElementById('convai-widget');
            if (widget) {
                widget.addEventListener('audioStart', handleAudioStart);
                widget.addEventListener('audioEnd', handleAudioEnd);
                widget.addEventListener('interruption', handleInterruption);
                widget.addEventListener('connectionUpdate', handleConnection);
                widget.addEventListener('error', handleError);
                widget.addEventListener('message', handleWidgetMessage);
                
                // Also add audio monitoring
                widget.addEventListener('play', () => {
                    log('AUDIO', '▶️ Play event detected');
                    switchBackground(true);
                }, true);
                
                widget.addEventListener('pause', () => {
                    log('AUDIO', '⏸️ Pause event detected');
                    switchBackground(false);
                }, true);

                log('INIT', 'All event listeners attached to widget');
            }
        });

        // Additional WebSocket monitoring
        function checkWebSocketConnections() {
            const allWebSockets = window.performance.getEntriesByType("resource")
                .filter(entry => entry.initiatorType === "xmlhttprequest" || entry.name.includes('websocket'));
            
            if (allWebSockets.length > 0) {
                log('CONNECTION', 'WebSocket connections found', allWebSockets);
            }
        }

        // Check connections periodically
        setInterval(checkWebSocketConnections, 5000);

        // Monitor for any audio elements added to the page
        const audioObserver = new MutationObserver((mutations) => {
            mutations.forEach(mutation => {
                mutation.addedNodes.forEach(node => {
                    if (node.tagName === 'AUDIO') {
                        log('AUDIO', '🔊 New audio element detected');
                        node.addEventListener('play', handleAudioStart);
                        node.addEventListener('ended', handleAudioEnd);
                        node.addEventListener('pause', handleAudioEnd);
                    }
                });
            });
        });

        audioObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
</body>
</html>
