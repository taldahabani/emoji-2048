<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emma AI Assistant</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
        }
        .background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: #000;
        }
        .background-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            max-width: 100vw;
            max-height: 100vh;
            transition: opacity 0.3s ease;
        }
        elevenlabs-convai {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 1;
            padding-bottom: env(safe-area-inset-bottom);
        }
        #debugPanel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
        }
        @media screen and (max-width: 768px) {
            .background-image {
                object-position: center center;
            }
        }
    </style>
</head>
<body>
    <div id="debugPanel"></div>
    <div class="background-container">
        <img id="backgroundImage" class="background-image" src="./emma.png" alt="Emma Background">
    </div>
    
    <elevenlabs-convai agent-id="UFCiWykxf7I8pgANcBuJ"></elevenlabs-convai>
    
    <script src="https://elevenlabs.io/convai-widget/index.js"></script>
    <script>
        // Debug logging function
        function logDebug(message, data = null) {
            const debugPanel = document.getElementById('debugPanel');
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const debugMessage = `[${timestamp}] ${message}`;
            
            console.log(debugMessage, data);
            
            const logEntry = document.createElement('div');
            logEntry.textContent = data ? 
                `${debugMessage} ${JSON.stringify(data)}` : 
                debugMessage;
            
            debugPanel.appendChild(logEntry);
            debugPanel.scrollTop = debugPanel.scrollHeight;
            
            while (debugPanel.children.length > 50) {
                debugPanel.removeChild(debugPanel.firstChild);
            }
        }

        // Wait for the widget to load and initialize
        function waitForConvai() {
            return new Promise((resolve, reject) => {
                if (window.Conversation) {
                    resolve(window.Conversation);
                } else {
                    logDebug('Waiting for Convai to initialize...');
                    const checkInterval = setInterval(() => {
                        if (window.Conversation) {
                            clearInterval(checkInterval);
                            resolve(window.Conversation);
                        }
                    }, 100);

                    // Timeout after 10 seconds
                    setTimeout(() => {
                        clearInterval(checkInterval);
                        reject(new Error('Timeout waiting for Convai to initialize'));
                    }, 10000);
                }
            });
        }

        // Initialize everything after the page loads
        window.addEventListener('load', async () => {
            logDebug('Page loaded, waiting for widget initialization...');
            
            try {
                // Wait for the Conversation object to be available
                const Conversation = await waitForConvai();
                logDebug('Convai widget initialized');

                // Add widget ready listener
                document.querySelector('elevenlabs-convai').addEventListener('ready', () => {
                    logDebug('Convai widget ready event fired');
                });

                const conversation = await Conversation.startSession({
                    signedUrl: signedUrl,
                    clientTools: {
                        switchbackground: async (parameters) => {
                            logDebug('switchbackground called with parameters:', parameters);
                            
                            try {
                                const bgImage = document.getElementById('backgroundImage');
                                const newSrc = parameters.speaking ? './emma2.png' : './emma.png';
                                
                                logDebug(`Switching background to: ${newSrc}`);
                                bgImage.src = newSrc;
                                
                                logDebug('Background switch completed');
                            } catch (error) {
                                logDebug('Error in switchbackground:', error.message);
                                throw error;
                            }
                        }
                    }
                });

                logDebug('Conversation session started successfully');
                
                // Debug event listeners
                conversation.on('message', (message) => {
                    logDebug('Message received:', message);
                });
                
                conversation.on('error', (error) => {
                    logDebug('Conversation error:', error);
                });
                
            } catch (error) {
                logDebug('Error starting conversation:', error.message);
                console.error('Full error:', error);
            }
        });

        // Global error handlers
        window.onerror = function(msg, url, line, col, error) {
            logDebug('Global error:', {
                message: msg,
                url: url,
                line: line,
                col: col
            });
            return false;
        };

        window.addEventListener('unhandledrejection', function(event) {
            logDebug('Unhandled Promise rejection:', event.reason);
        });
    </script>
</body>
</html>
